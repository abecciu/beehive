#!/usr/bin/env ruby
require 'rubygems'
require 'ap'

def figure_route(controller, http_method, line)
  route = {}
  base = controller
  paths = line[/\(.+\)/].gsub(/\(|\)|, _Data|\[|\]/, "").split(", ")
  paths = paths.map do |path|
    case path
    when /^_$/
      ""
      # path
    when /^".+"$/
      path.gsub(/"/,"")
      # path
    else
      ":" + path unless path.empty?
      # path
    end
  end
  route[:method] = http_method.to_s.upcase
  route[:uri] = controller + "/" + paths.join("/")
  route[:controller] = controller
  route
end

CONTROLLER_DIR = File.join(File.dirname(__FILE__), "..", "lib/erlang/apps/beehive/src/bh_rest/app_controllers/")

controller_files = Dir.entries(CONTROLLER_DIR) - %w(. ..)



route_hash = {}
routes = []
# file = controller_files.first
controller_files.each do |file|
  controller = file.gsub(/_controller.erl$/, "")
  route_hash[file] = []
  lines = File.open(CONTROLLER_DIR + file).readlines
  lines.each do |line|
    case line
    when /^get\(/
      http_method = :get
    when /^post\(/
      http_method = :post
    when /^put\(/
      http_method = :put
    when /^delete\(/
      http_method = :delete
    end
    route = figure_route(controller, http_method, line) if http_method
    route_hash[file] << route
    routes << route
  end
end

routes.compact!

# routes = routes.collect do |route|
#   name = route[:controller]
#   verb = route[:method].to_s.upcase
#   uri = route[:uri]
#   {:name => name, :verb => verb, :uri => uri}
# end
controller_width = routes.collect {|r| r[:controller]}.collect {|n| n.length}.max
method_width = routes.collect {|r| r[:method]}.collect {|v| v.length}.max
uri_width = routes.collect {|r| r[:uri]}.collect {|s| s.length}.max
last_controller = ""
routes.each do |r|
  ctrl_display = (r[:controller] == last_controller) ? "" : r[:controller]
  puts "#{ctrl_display.rjust(controller_width)} #{r[:method].ljust(method_width)} #{r[:uri].ljust(uri_width)}"
  last_controller = r[:controller]
end


# ap route_hash
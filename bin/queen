#!/bin/sh

progdir=$(dirname $0)
progname=$(basename $0)
grep=$(which grep)
version="0.1"

print_usage() {
cat <<EOF

Usage: $progname options [ACTION]

Manage beehive

ACTIONS
  install                       Installs beehive
  remove                        Removes beehive from the system

OPTIONS
  -t, --type                    Type of node to install on beehive [router]|node|storage
  -p, --prefix                  The root directory (default: /opt/beehive)
  -V, --version                 Print the version
  -h, --help                    Show this screen
	
EOF
}

print_version() {
cat <<EOF
$progname $version

Copyright (C) 2009 Ari Lerner
EOF
}

# Defaults
PREFIX="/opt/beehive"
TYPE="router"
# Opts
SHORTOPTS="hp:t:"
LONGOPTS="help,version,prefix,type"

if $(getopt -T >/dev/null 2>&1) ; [ $? = 4 ] ; then # New longopts getopt.
	OPTS=$(getopt -o "$SHORTOPTS" --longoptions "$LONGOPTS" -n "$progname" -- "$@")
else # Old classic getopt.
  # Special handling for --help and --version on old getopt.
	case $1 in --help) print_usage ; exit 0 ;; esac
	case $1 in --version) print_version ; exit 0 ;; esac
	OPTS=$(getopt $SHORTOPTS "$@")
fi

if [ $? -ne 0 ]; then
	echo "'$progname --help' for more information" 1>&2
	exit 1
fi

# eval set -- "$OPTS"
while [ $# -gt 0 ]; do
   : debug: $1
   case "$1" in
		--help)
			usage
			exit 0
			;;
		-p|--prefix)
		  PREFIX="$2"
		  shift 2
		  ;;
		-t|--type)
		  case "$2" in
		    r|router )
		      TYPE="router";;
		    n|node )
		      TYPE="node";;
		    s|storage )
		      TYPE="storage";;
		    *)
		      echo "
ERROR! Unknown type of node. Must be one of the following
(r)router
(n)node
(s)storage
		      "
		      exit 1
		      ;;
		  esac
		  shift 2
		  ;;
		--)
			shift
			break;;
		install)
		  ACTION="install"
		  shift 1
		  ;;
		remove)
		  ACTION="remove"
		  shift 1
		  ;;
		*)
			print_usage; exit 0
			;;
	esac
done

SRC_DIR="$PREFIX/sys"
SETUP_SCRIPTS_DIR="$progdir/../config/user-data"
ERL_SRC_DIR="$progdir/../lib/erlang/"

case $ACTION in
  "install" )
    echo "Installing beehive ($TYPE) into $PREFIX"
    mkdir -p $SRC_DIR
    cp -R $ERL_SRC_DIR $SRC_DIR
    /bin/bash $SETUP_SCRIPTS_DIR/$TYPE.sh
    ;;
  "remove" )
    echo "Removing beehive from $PREFIX"
    ;;
  *)
    echo "Unknown action"
esac

export PATH=$PATH:/
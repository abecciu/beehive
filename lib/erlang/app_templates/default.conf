# Config file
# This is a default configuration file
# If you do not specify an action, the action here will be run
bundle: do
  git clone --depth 0 $REPOS $WORKING_DIRECTORY
  pushd $WORKING_DIRECTORY
  SHA=`git log --max-count=1 | awk '/commit/ {print $2}'`
  popd
  FILE=$SQUASHED_DIRECTORY/$NAME-$SHA.tgz
  pushd $SQUASHED_DIRECTORY
  pwd
  tar -C $WORKING_DIRECTORY -czf $FILE .
  ln -sF $FILE $SQUASHED_FILE
  # This is important to extract the sha
  echo "{sha, \"$SHA\"}." > $ENV_FILE
  popd
end
bundle.after: do
  if [ -d "$WORKING_DIRECTORY" ]; then
    rm -rf $WORKING_DIRECTORY
  fi
end
mount: tar -C $TARGET_DIRECTORY -zxf $BEE_IMAGE
start: do
  env > /tmp/start.env
  if [ ! -d "$RUN_DIR/tmp/pids" ]; then
    mkdir -p $RUN_DIR/tmp/pids
  fi
  thin -R config.ru -P$RUN_DIR/tmp/pids/$NAME-$PORT.pid -p $PORT start -d 1> $LOG_DIRECTORY/output.log 2> $LOG_DIRECTORY/error.log
end
stop: do
  thin -R config.ru -P$RUN_DIR/tmp/pids/$NAME-$PORT.pid stop
end
unmount:
cleanup:
